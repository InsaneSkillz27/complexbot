"use strict";

var fs = require('fs');
var path = require('path');

var Q = require('q');

var prompt = require('../util/prompt');
var util = require('../util/util');
var colors = require('../util/colors');
var cmd = require('../util/cmd');
var gitlab = require('../util/gitlab');

/**
 * 创建一个git项目
 * fpm create
 * @moduleName 组件名称
 */

var initconfig = function () {
  var options = [{
    message: '请输入您的git用户名',
    require: true,
    name: 'login'
  }, {
    message: '请输入您的git邮箱',
    require: true,
    name: 'email'
  }, {
    message: '请输入您的git密码',
    require: true,
    name: 'password'
  }, {
    message: '请输入git的host地址',
    require: true,
    name: 'hostname'
  }];

  var result = prompt(options);
  var token = result.then(result => {
    gitlab.getToken({login: result.login, password: result.password});
  });

  Q.all([result, token])
    .spread(result => {
      var cmdEmail = cmd('git', ['config', '--global', 'user.email', result.email]);
      var cmdName = () => cmd('git', ['config', '--global', 'user.name', result.login]);
      var cmdPassword = () => cmd('git', ['config', '--global', 'user.password', result.password]);
      var cmdHostname = () => cmd('git', ['config', '--global', 'user.hostname', result.hostname]);
      cmdEmail
        .then(cmdName)
        .then(cmdPassword)
        .then(cmdHostname)
        .then(() => {
          console.log(colors.green('信息设置完成'));
          process.exit();
        });
    })
    .catch(e=>{
      console.log(colors.red('信息填写有误，请重新填写'));
      initconfig();
    });
};

// -------------------

initconfig.line = function (argv) {
    return initconfig();
};

module.exports = initconfig;